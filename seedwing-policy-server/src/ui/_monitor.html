
{{#> layout }}
<style>

  .pf-c-table {
      --pf-c-table--cell--FontSize: var(--pf-global--FontSize--sm);
      --pf-c-table--cell--PaddingLeft: none;
      --pf-c-table--cell--PaddingRight: none;
      --pf-c-table--cell--PaddingTop: none;
      --pf-c-table--cell--PaddingBottom: none;
  }

  #events .satisfied {
    background-color: #cfc;
  }

  #events .unsatisfied {
    background-color: #fcc;
  }

  #events .error {
    background-color: #ccf;
  }

</style>

<table
    class="pf-c-table pf-m-grid-md"
    role="grid"
    aria-label="This is a simple table example"
    id="table-basic"
>
  <caption>Pattern evaluation monitor</caption>
  <thead>
  <tr role="row">
    <th role="columnheader" scope="col">Pattern</th>
    <th role="columnheader" scope="col">Time</th>
    <th role="columnheader" scope="col">Input</th>
    <th role="columnheader" scope="col">Output</th>
  </tr>
  </thead>

  <tbody role="rowgroup" id="events">
  </tbody>
</table>

<script defer>
  const loc = window.location;
  const stream = new WebSocket("ws://" + loc.host + loc.pathname.replace( "/monitor/", "/monitor-stream/" ));
  stream.onmessage = (ws_event) => {
    const event = JSON.parse(ws_event.data);
    if (event.type == "start") {

      var row = $("<tr role='row' id='" + event.event.correlation + "'>")
        .append( $( "<td role='cell' class='pattern' data-label='Pattern'>" ).text( event.event.name ) )
        .append( $( "<td role='cell' data-label='Time'>" )
          .append( $( "<div class='start'>" ).text( event.event.timestamp ) )
          .append( $( "<div class='complete'>" ) )
        )
        .append( $( "<td role='cell' class='input' data-label='Input'>" )
          .append( $( "<pre>" ).text( JSON.stringify(event.event.input, null, 2) ) )
        )
        .append( $( "<td role='cell' class='output' data-label='Output'>" ) )

      $("#events").prepend( row );

    } else if (event.type == "complete" ) {
      $("#" + event.event.correlation + " .complete").text( event.event.timestamp );
      if ( event.event.output.type == "none" ) {
        $("#" + event.event.correlation).addClass( "unsatisfied" );
      } else if (event.event.output.type == "identity" ) {
        $("#" + event.event.correlation).addClass( "satisfied" );
        $("#" + event.event.correlation + " .output").append( $("<i>identity</i>" ) );
      } else if (event.event.output.type == "transform") {
        $("#" + event.event.correlation).addClass( "satisfied" );
        const output = JSON.stringify(event.event.output.value, null, 2);
        $("#" + event.event.correlation + " .output").append( $("<pre>").text(output));
      } else {
        $("#" + event.event.correlation).addClass( "error" );
        $("#" + event.event.correlation + " .output").append( $("<b>").text(event.event.output.value.err));
      }
    }
  }
</script>

{{/layout}}