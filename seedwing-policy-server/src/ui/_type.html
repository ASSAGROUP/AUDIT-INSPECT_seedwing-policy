{{#> layout }}

<script src="/ui/asciidoctor/asciidoctor.js"></script>
<script src="/ui/monaco/min/vs/loader.js"></script>

<style>

  #documentation {
    margin-bottom: 1em;
  }

  #documentation h2 {
    margin-top: 0;
  }

  .sw-rationale {
    font-size: 80%;
  }

  .sw-rationale code {
    font-weight: 900;
    padding: 0;
  }

  .sw-rationale div.entry {
    padding: 1ex;
    border-left: 1px solid #333;
    margin-bottom: 1ex;
  }

  .sw-rationale div.field {
    border-bottom: 1px dotted #ccc;
    padding-bottom: 1ex;
    background-color: inherit;
  }

  .sw-rationale div.field-name {
    background-color: inherit;
  }

  .sw-rationale div.satisfied {
    background-color: #cfc;
  }

  .sw-rationale div.unsatisfied {
    background-color: #fcc;
  }

  .sw-rationale div.satisfied:hover {
    background-color: #9f9;
  }

  .sw-rationale div.unsatisfied:hover {
    background-color: #f99;
  }

  .sw-rationale code {
    background-color: inherit;
  }

  .sw-rationale .input {
    background-color: #eee;
    border: 1px solid #ccc;
    padding: 1ex;
    margin-bottom: 1em;
  }

   #type-definition {
    font-size: 1em;
  }
  #type-definition pre {
    margin-top: 1em;
  }

  #type-definition div {
    margin-left: 1em;
    border-left: 1px dotted #ccc;
  }

</style>

<h1 class="pf-c-title pf-m-4xl">
  <span><a href="/policy/">Policies</a> | </span>
  {{#each breadcrumbs.crumbs}}
  {{#if this.link}}
  <span><a href="{{this.link}}">{{this.text}}</a>::</span>
  {{else}}
  <span>{{this.text}}</span>
  {{/if}}
  {{/each}}
</h1>

<!--
<h1 class="pf-c-title pf-m-4xl">
  {{#if path_segments}}
  {{#each path_segments}}
  <span>{{this}} :: </span>
  {{/each}}
  {{else}}
  [Root]
  {{/if}}
</h1>
-->

<div class="pf-m-gutter pf-l-grid pf-m-all-12-col-on-sm pf-m-all-6-col-on-md">
  <div class="pf-l-grid__item">
    <div class="pf-c-panel">
      <div class="pf-c-panel__main">
        <div class="pf-c-panel__header">Documentation</div>
        <hr class="pf-c-divider"/>
        <div class="pf-c-panel__main-body">
          <div id="documentation" class="adoc">{{documentation}}</div>
        </div>
      </div>
    </div>
    <hr class="pf-c-divider"/>
    <div class="pf-c-panel">
      <div class="pf-c-panel__main">
        <div class="pf-c-panel__header">Definition</div>
        <hr class="pf-c-divider"/>
        <div class="pf-c-panel__main-body">
          <div class="pf-c-code-block">
            <div class="pf-c-code-block__content">
              <pre class="pf-c-code-block__pre" id="type-definition"><code class="pf-c-code-block__code">{{&definition}}</code></pre>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {{#if parameters}}
  <div class="pf-l-grid__item">
    <div class="pf-c-panel">
      <div class="pf-c-panel__header">Experiment</div>
      <hr class="pf-c-divider"/>
      <div class="pf-c-panel__main">
        <div class="pf-c-panel__main-body">
          <p>Parameterized patterns may not be experimented upon directly.</p>
          <p>They should be used in another named pattern, with their parameters bound to concrete types.</p>
        </div>
      </div>
    </div>
  </div>
  {{else}}
  <div class="pf-l-grid__item">
    <div class="pf-c-toolbar">
      <div class="pf-c-toolbar__content">
        <div class="pf-c-toolbar__item">Experiment</div>
        <div class="pf-c-toolbar__item pf-m-align-right">
          <button id="experiment_post" class="pf-c-button pf-m-progress pf-m-secondary">
                <span class="pf-c-button__progress">
                  <span class="pf-c-spinner pf-m-md" role="progressbar" aria-label="Loading...">
                    <span class="pf-c-spinner__clipper"></span>
                    <span class="pf-c-spinner__lead-ball"></span>
                    <span class="pf-c-spinner__tail-ball"></span>
                  </span>
                </span>
            POST
          </button>
        </div>
      </div>
    </div>
    <div class="pf-c-panel">
      <div class="pf-c-banner" id="experiment_status">POST {{url_path}}</div>

      <div class="pf-c-panel__main">
        <div class="pf-c-panel__main-body">

          <form id="experiment_form" class="pf-c-form">
            <div id="experiment_body" style="width: 100%; height: 20em; font-family: monospace;"></div>
            <script>
              require.config({ paths: { vs: '/ui/monaco/min/vs' } });

              require(['vs/editor/editor.main'], function () {
                  var editor = monaco.editor.create(document.getElementById('experiment_body'), {
                    minimap: {enabled: false}
                  });

                  const form = document.getElementById("experiment_form");
                  form.addEventListener("formdata", e =>
                  {
                      e.formData.append('body', editor.getModel().getValue());
                  });
              });
            </script>
          </form>

        </div>
      </div>
    </div>

    <div class="pf-c-panel" id="rationale">
      <div class="pf-c-panel__header">Rationale</div>
      <div class="pf-c-panel__main">
        <div class="pf-c-panel__main-body sw-rationale" id="rationale_body">
          Rationale goes here.
        </div>
      </div>
    </div>
    <div class="pf-c-panel pf-m-gold" id="error">
      <div class="pf-c-panel__header">Error</div>
      <div class="pf-c-panel__main">
        <div class="pf-c-panel__main-body" id="error_body">
          Error goes here.
        </div>
      </div>
    </div>
  </div>
  {{/if}}
</div>


<script defer>
  const adoc = Asciidoctor();
  const documentation = $("#documentation").text();
  const converted = adoc.convert(documentation, {"safe": "safe"});
  $("#documentation").html(converted);

  $("#documentation ul").addClass("pf-c-list");

  $("#rationale").hide();
  $("#error").hide();

  $("#experiment_post").on("click", event => {
    $("#rationale").hide();
    $("#error").hide();
    $("#experiment_post")
        .prop("disabled", true)
        .addClass("pf-m-in-progress");
    $('#experiment_status').removeClass("pf-m-gold");
    $('#experiment_status').removeClass("pf-m-green");
    $('#experiment_status').removeClass("pf-m-red");
    $('#rationale_body').html("");
    event.preventDefault();
    const body = new FormData(document.getElementById('experiment_form')).get("body");
    $.post(
        "{{url_path}}",
        body,
        result => {
          $('#rationale_body').html(result);
          $("#rationale").show();
          $('#experiment_status').removeClass("pf-m-gold");
          $('#experiment_status').removeClass("pf-m-red");
          $('#experiment_status').addClass("pf-m-green");
        }
    ).fail(arg => {
      if (arg.status == 422) {
        $('#rationale_body').html(arg.responseText);
        $("#rationale").show();
        $('#experiment_status').removeClass("pf-m-gold");
        $('#experiment_status').removeClass("pf-m-green");
        $('#experiment_status').addClass("pf-m-red");
      } else {
        $('#error_body').html(arg.responseText);
        $("#error").show();
        $('#experiment_status').removeClass("pf-m-green");
        $('#experiment_status').removeClass("pf-m-red");
        $('#experiment_status').addClass("pf-m-gold");
      }
    }).always(function (arg) {
      $("#experiment_post")
          .removeClass("pf-m-in-progress")
          .prop("disabled", false);
    })
  })

</script>

{{/layout}}